# CNN-for-Trading 项目实际配置总结

## 一、输入数据格式

### 1.1 图像尺寸规格
- **5天模型 (CNN5d)**：输入图像尺寸 `[N, 1, 32, 15]`
  - 高度：32像素
  - 宽度：15像素 (5天 × 3像素/天)
  - 通道数：1 (黑白图像)

- **20天模型 (CNN20d)**：输入图像尺寸 `[N, 1, 64, 60]`
  - 高度：64像素
  - 宽度：60像素 (20天 × 3像素/天)
  - 通道数：1 (黑白图像)

- **60天模型 (CNN60d)**：输入图像尺寸 `[N, 1, 96, 180]`
  - 高度：96像素
  - 宽度：180像素 (60天 × 3像素/天)
  - 通道数：1 (黑白图像)

### 1.2 图像内容构成
- **OHLC数据**：开盘价、最高价、最低价、收盘价
- **交易量**：日交易量数据
- **移动平均线**：窗口长度与图像时间跨度一致
- **布局分配**：
  - 交易量占据图像高度的1/5
  - OHLC数据与移动平均线占据剩余的4/5空间

### 1.3 像素规则
- **1天 = 3像素**：1个中心柱 + 1个开盘标记 + 1个收盘标记
- **颜色编码**：
  - 白色像素 (255)：价格数据点
  - 黑色像素 (0)：背景/空白区域

### 1.4 数据标准化
- **价格标准化**：将图像周期内的最高价和最低价分别映射到图像的顶部和底部
- **交易量标准化**：依据图像周期内的最大交易量进行归一化
- **图像归一化**：对训练数据像素取均值和标准差进行归一化

## 二、模型架构参数

### 2.1 CNN5d 模型 (5天输入预测5天回报)

#### 网络结构
- **构建块数量**：2个卷积块
- **输入尺寸**：`[N, 1, 32, 15]`
- **输出尺寸**：`[N, 2]`

#### 卷积层详细参数
```
Conv Block 1:
- Conv2d(1, 64, kernel_size=(5,3), padding=(2,1), stride=(1,1), dilation=(1,1))
- BatchNorm2d(64)
- LeakyReLU()
- MaxPool2d((2,1), stride=2)

Conv Block 2:
- Conv2d(64, 128, kernel_size=(5,3), padding=(2,1), stride=(1,1), dilation=(1,1))
- BatchNorm2d(128)
- LeakyReLU()
- MaxPool2d((2,1), stride=2)
```

#### 全连接层
- **输入维度**：15,360 (128 × 8 × 15)
- **输出维度**：2
- **Dropout率**：50%

#### 参数统计
- **总参数数量**：155,138
- **权重初始化**：Xavier Uniform
- **偏置初始化**：0.01

### 2.2 CNN20d 模型 (20天输入预测20天回报)

#### 网络结构
- **构建块数量**：3个卷积块
- **输入尺寸**：`[N, 1, 64, 60]`
- **输出尺寸**：`[N, 2]`

#### 卷积层详细参数
```
Conv Block 1:
- Conv2d(1, 64, kernel_size=(5,3), padding=(2,1), stride=(1,1), dilation=(2,1))
- BatchNorm2d(64)
- LeakyReLU()
- MaxPool2d((2,1), stride=2)

Conv Block 2:
- Conv2d(64, 128, kernel_size=(5,3), padding=(2,1), stride=(1,1), dilation=(1,1))
- BatchNorm2d(128)
- LeakyReLU()
- MaxPool2d((2,1), stride=2)

Conv Block 3:
- Conv2d(128, 256, kernel_size=(5,3), padding=(2,1), stride=(1,1), dilation=(1,1))
- BatchNorm2d(256)
- LeakyReLU()
- MaxPool2d((2,1), stride=2)

Extra Pool:
- MaxPool2d((1,2))  # 调整维度以匹配FC输入要求
```

#### 全连接层
- **输入维度**：61,440 (256 × 8 × 30)
- **输出维度**：2
- **Dropout率**：50%

#### 参数统计
- **总参数数量**：708,866
- **权重初始化**：Xavier Uniform
- **偏置初始化**：0.01

### 2.3 CNN60d 模型 (60天输入预测60天回报)

#### 网络结构
- **构建块数量**：4个卷积块
- **输入尺寸**：`[N, 1, 96, 180]`
- **输出尺寸**：`[N, 2]`

#### 卷积层详细参数
```
Conv Block 1:
- Conv2d(1, 64, kernel_size=(5,3), padding=(2,1), stride=(1,1), dilation=(3,1))
- BatchNorm2d(64)
- LeakyReLU()
- MaxPool2d((2,1), stride=2)

Conv Block 2:
- Conv2d(64, 128, kernel_size=(5,3), padding=(2,1), stride=(1,1), dilation=(1,1))
- BatchNorm2d(128)
- LeakyReLU()
- MaxPool2d((2,1), stride=2)

Conv Block 3:
- Conv2d(128, 256, kernel_size=(5,3), padding=(2,1), stride=(1,1), dilation=(1,1))
- BatchNorm2d(256)
- LeakyReLU()
- MaxPool2d((2,1), stride=2)

Conv Block 4:
- Conv2d(256, 512, kernel_size=(5,3), padding=(2,1), stride=(1,1), dilation=(1,1))
- BatchNorm2d(512)
- LeakyReLU()
- MaxPool2d((2,1), stride=2)

Extra Pool:
- MaxPool2d((1,3))  # 调整维度以匹配FC输入要求
```

#### 全连接层
- **输入维度**：184,320 (512 × 6 × 60)
- **输出维度**：2
- **Dropout率**：50%

#### 参数统计
- **总参数数量**：2,952,962
- **权重初始化**：Xavier Uniform
- **偏置初始化**：0.01

### 2.4 通用网络组件

#### 激活函数
- **类型**：LeakyReLU
- **公式**：`LeakyReLU(x) = max(0, x) + 0.01 * min(0, x)`
- **功能**：避免ReLU的"神经元死亡"问题

#### 池化层
- **类型**：MaxPool2d
- **核尺寸**：(2,1) - 垂直2像素，水平1像素
- **步长**：2
- **功能**：降维、去噪、增强鲁棒性

#### 正则化
- **批量归一化**：在每个卷积层后应用
- **Dropout**：仅在全连接层应用，dropout率50%
- **卷积层**：不使用Dropout（因参数共享机制）

## 三、训练参数设定

### 3.1 优化器配置
- **优化算法**：Adam
- **初始学习率**：1e-5 (0.00001)
- **权重衰减**：0.01
- **批量大小**：128

### 3.2 损失函数
- **类型**：CrossEntropyLoss
- **公式**：`L(y, ŷ) = -y*log(ŷ) - (1-y)*log(1-ŷ)`
- **用途**：二分类任务

### 3.3 训练策略
- **训练轮数**：100 epochs
- **早停机制**：验证损失连续2个epoch无改善时停止
- **验证比例**：30%
- **数据采样率**：20%

### 3.4 数据集配置
- **训练数据时间范围**：1993年1月1日 - 2000年12月31日
- **测试数据时间范围**：2001年1月1日 - 2019年12月31日
- **数据源**：Yahoo Finance历史数据
- **包含指数**：S&P 500, NASDAQ, Dow Jones

### 3.5 标签定义
- **y = 1**：未来收益为正
- **y = 0**：未来收益为负
- **预测目标**：
  - RET5：未来5天收益
  - RET20：未来20天收益
  - RET60：未来60天收益

## 四、输出格式

### 4.1 模型输出
- **输出维度**：`[N, 2]`
- **输出类型**：Softmax概率分布
- **输出含义**：
  - `[prob_down, prob_up]`
  - `prob_down`：下跌概率
  - `prob_up`：上涨概率

### 4.2 预测结果
- **预测类别**：`torch.argmax(output, 1)`
- **置信度**：`torch.max(output, 1)`
- **概率阈值**：通常使用0.5作为分类阈值

### 4.3 模型评估指标
- **准确率**：正确预测的样本比例
- **损失值**：CrossEntropy损失
- **类别准确率**：各类别的独立准确率

## 五、文件结构

### 5.1 配置文件
```
configs/
├── I5R5/
│   └── I5R5_93-00_train.yml    # 5天输入预测5天回报
├── I20R20/
│   └── I20R20_93-00_train.yml  # 20天输入预测20天回报
├── I60R60/
│   └── I60R60_93-00_train.yml  # 60天输入预测60天回报
└── test_small.yml              # 测试配置
```

### 5.2 模型文件
```
models/
├── I5R5_OHLCV/
│   └── I5R5_OHLCV_93-00_train.tar
├── I20R20_OHLCV/
│   └── I20R20_OHLCV_93-00_train.tar
└── I60R60_OHLCV/
    └── I60R60_OHLCV_93-00_train.tar
```

### 5.3 核心代码文件
- **model.py**：CNN模型定义
- **main.py**：训练主程序
- **test.py**：测试程序
- **dataset.py**：数据加载和图像生成
- **train.py**：训练循环逻辑

## 六、运行方式

### 6.1 训练模型
```bash
# 训练5天模型
python main.py configs/I5R5/I5R5_93-00_train.yml

# 训练20天模型
python main.py configs/I20R20/I20R20_93-00_train.yml

# 训练60天模型
python main.py configs/I60R60/I60R60_93-00_train.yml
```

### 6.2 测试模型
```bash
# 测试模型
python test.py configs/I5R5/I5R5_93-00_train.yml
```

### 6.3 推理预测
```bash
# 模型推理
python inference.py configs/I5R5/I5R5_93-00_train.yml
```

## 七、技术特点总结

### 7.1 创新点
- **图像化时间序列**：将金融时间序列转换为2D图像
- **多尺度架构**：不同时间跨度对应不同的网络深度
- **膨胀卷积**：通过dilation扩大感受野
- **固定模型策略**：训练一次，测试期参数不变

### 7.2 技术优势
- **参数效率**：通过参数共享减少参数量
- **位置不变性**：对价格模式位置具有鲁棒性
- **非线性关系捕捉**：能够识别复杂的价格模式
- **端到端学习**：无需手工特征工程

### 7.3 实际应用
- **股票收益预测**：预测未来5/20/60天的收益方向
- **风险管理**：通过概率输出评估投资风险
- **量化交易**：构建多空策略组合

---

*本文档基于 CNN-for-Trading 项目的实际代码和配置文件生成，反映了项目的真实技术实现。*
