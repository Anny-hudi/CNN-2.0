# CNN 模型参数与训练设定

## 一、模型架构

### CNN架构优势
- **参数效率**：CNN通过施加跨参数限制，显著减少了与标准前馈神经网络相比的参数数量，提高了训练的可操作性和预测的有效性
- **位置不变性**：CNN对图像中物体的位置、大小和方向具有鲁棒性，解决了传统神经网络对物体位置敏感的问题
- **模块化设计**：使用核心构建块进行组装，可根据具体应用进行不同配置

### 模型结构

#### 基础组件参数
- **输入数据**：黑白图像（像素值为 0 或 255）
- **输出**：二分类（`y=1` 表示正收益，`y=0` 表示负收益）

#### 卷积层详细参数
- **滤波器尺寸**：5×3像素（垂直5像素×水平3像素）
- **水平步长**：1（滤波器水平方向每次移动1像素）
- **垂直步长**：根据图像时间跨度调整
  - 5天图像：1
  - 20天和60天图像：3
- **垂直dilation率**：适配不同时间跨度
  - 5天图像：1
  - 20天图像：2
  - 60天图像：3
- **零填充（Padding）**：确保卷积操作后图像尺寸保持不变
- **感受野扩展**：通过dilation扩大对稀疏长周期图像的感受野
- **膨胀滤波器原理**：膨胀滤波器通过沿垂直或水平方向的膨胀率k，在相应维度的相邻条目之间填充（k-1）个零，从而扩大原始滤波器的大小
- **基线模型设置**：垂直方向使用两倍膨胀，水平方向无膨胀

#### 激活层参数
- **激活函数**：Leaky ReLU，公式为 $LeakyReLU(x)=\begin{cases}x, & x≥0 \\ 0.01x, & x<0\end{cases}$
- **功能**：引入非线性，避免传统ReLU函数可能出现的"神经元死亡"问题，对负输入保留微小梯度，保证梯度传播的稳定性

#### 池化层参数
- **池化方式**：最大池化（Max-Pooling）
- **池化核尺寸**：2×1像素（垂直2像素×水平1像素）
- **步长**：2
- **功能**：
  - **降维作用**：在垂直方向将图像尺寸压缩1/2，水平方向保持不变
  - **去噪功能**：通过在整个图像中选取局部最大值，输出通常不会受到输入模式微小变化的影响，增强CNN对局部变形的鲁棒性
  - **信息整合**：如果滤波区域中的任何神经元被激活，最大池化机制会检测到这一情况，同时丢弃局部冗余信息
  - **简洁性**：无需引入新的参数进行估计，进一步促进CNN的简洁性

#### 网络构建块
- **每个卷积块**：Conv → BN → Leaky ReLU → MaxPool
- **张量处理**：输入为维度h×w×d的张量，其中d为通道数
- **特征组合过程**：通过将许多构建块堆叠，网络首先创建图像的小部分表示，然后逐渐将它们组装成更大区域的表示
- **最终层**：
  - **全连接层**（FC）：将最后一个CNN构建模块的输出展平成向量，每个元素被视为标准全连接前馈层中的特征
  - **Softmax**：输出二分类概率（"上升"和"下降"），拟合值实际上是对正向结果概率的估计

#### CNN关键特性
- **参数共享（Parameter Sharing）**：
  - 在图像的所有位置均匀应用小滤波器，而一般网络允许为图像矩阵的每个元素设置独立的权重参数
  - 相同的滤波器被均匀应用于图像的所有位置，无论目标物的位置如何，都能检测到相关对象
- **稀疏交互（Sparse Interactions）**：
  - 仅将输入矩阵中某个位置的信息映射到输出矩阵中相同位置的邻域
  - 一般的网络则允许输入和输出矩阵的所有元素之间存在交叉连接
- **平移等变性**：CNN的预测具有平移等变性特性，无论目标特征在图像中的位置如何，都能被检测到

### 模型复杂度（不同时间窗口）

#### 网络架构参数详情
- **5 天模型（I5）**：
  - 构建块数量：2个 CNN 构建模块
  - 滤波器数量：第1层64、第2层128
  - 全连接层神经元数量：15,360
  - 总参数数量：155,138

- **20 天模型（I20）**：
  - 构建块数量：3个 CNN 构建模块
  - 滤波器数量：第1层64、第2层128、第3层256
  - 全连接层神经元数量：46,080
  - 总参数数量：708,866

- **60 天模型（I60）**：
  - 构建块数量：4个 CNN 构建模块
  - 滤波器数量：第1层64、第2层128、第3层256、第4层512
  - 全连接层神经元数量：184,320
  - 总参数数量：2,952,962

#### 架构设计逻辑
- **深层滤波器数量**：
  - 呈翻倍趋势（64→128→256→512），以匹配更复杂的长周期价格模式
  - 学习到的特征在更深的层中变得更加复杂，遵循文献建议在每个卷积层之后将滤波器数量增加一倍
- **全连接层神经元数量**：由最后一个池化层输出维度（$H×W×D$）决定
  - H：高度
  - W：宽度
  - D：通道数
- **参数构成**：总参数数量包含卷积层和全连接层参数，批量归一化参数占比可忽略不计
- **正则化效果**：由于严格的正则化处理，大多数参数被压缩至接近零，因此模型的有效参数数量远少于总参数数量

### 1D vs 2D CNN 区别
- **1D CNN**：应用于时间序列数据，卷积滤波器宽度与数据矩阵相同，仅在时间维度上移动
- **2D CNN**：应用于图像数据，矩形滤波器可在图像矩阵中水平和垂直移动，能够捕捉不同价格曲线之间的非线性空间关系

### 图像表示优势
- **非线性关系捕捉**：将时间序列数据以图像形式嵌入，可以利用卷积滤波器捕捉不同价格曲线之间的非线性空间关系
- **特征自动整合**：图像自动整合方向性价格变动、相对于移动平均趋势的变动、价格波动性和交易量等信息，形成综合表示
- **避免手动特征设计**：传统时间序列模型需要手动设计特征，而2D CNN消除了手动设计这些特征的需求
- **模式识别优势**：正如人类更容易通过图形而非数字列表来识别模式，统计模式识别算法也可能从将整个数据矩阵可视化为单个图像中获益

---

## 二、训练数据设置

### 数据来源
- **数据源**：使用 `data/` 文件夹中的Yahoo Finance历史数据
  - S&P 500 (^GSPC) 历史数据
  - NASDAQ Composite (^IXIC) 历史数据  
  - Dow Jones Industrial Average (^DJI) 历史数据
- **时间范围**：1993年1月4日至2019年12月30日
- **数据字段**：每日开盘价、最高价、最低价、收盘价、调整后收盘价、成交量

### 价格序列构建方法

#### 价格序列重建
- **价格重建公式**：$p_{t+1} = (1 + RET_{t+1}) \cdot p_t$
  - 其中 $RET_{t+1}$ 为第t+1日的回报率
  - $p_t$ 为第t日的收盘价
- **CRSP调整**：基于CRSP调整后收益构建价格序列，规避拆股、分红等因素对价格的影响
- **标准化处理**：将首日收盘价设为1，作为基准价格

#### 数据标准化详细方法
- **价格维度标准化**：
  - 将图像周期内的最高价和最低价分别映射到图像的顶部和底部
  - 其他价格（开盘价、收盘价、移动平均价）按照比例进行缩放
- **交易量维度标准化**：
  - 依据图像周期内的最大交易量进行归一化
- **跨股票尺度统一**：消除跨股票尺度差异，保证图像可比性

### 图像表示技术细节

#### 时间跨度与像素尺寸规则
- **像素规则**：遵循"1天对应3个像素"的规则，即1个中心柱、1个开盘标记和1个收盘标记各占1个像素
- **图像尺寸规格**：
  - **5天图像**：宽度3×5=15像素，高度32像素
  - **20天图像**：宽度3×20=60像素，高度64像素
  - **60天图像**：宽度3×60=180像素，高度96像素

#### 图像布局与信息承载
- **核心信息**：包含OHLC数据（开盘价、最高价、最低价、收盘价）、日交易量以及移动平均线
- **布局分配**：交易量占据图像高度的1/5，OHLC数据与移动平均线占据剩余的4/5空间
- **移动平均线**：窗口长度与图像的时间跨度保持一致（20天图像对应20天移动平均）

#### 图像离散化与颜色编码
- **图像离散化**：将时间序列转换成黑白图像，其中"255"代表白色像素（对应于价格条目），"0"表示图像中的空白区域
- **离散化精度**：图像中y轴上的每个单位代表0.1，由于1.04与1.0之间的差异小于0.05，因此图像中的离散化价格在前两个周期内保持平稳
- **卷积滤波器检测**：使用5×3的卷积滤波器（垂直5像素×水平3像素），可以将"无变化"、"小幅上涨"和"大幅上涨"分别视为不同的特征，并以不同的权重进行最终预测
- **指示函数作用**：当这些滤波器应用于图像时，它们作为指示函数，能够检测并分类不同幅度的价格变动

#### 缺失值处理
- **缺失数据处理**：对于缺失数据，对应像素列会留空
  - 若仅缺失开盘价或收盘价，仅绘制垂直柱
  - 若缺失最高价或最低价，则整列涂黑
- **鲁棒性增强**：这种处理方式增强了模型对噪声数据的鲁棒性

### 样本划分与标签
- **样本划分**：
  - 训练集：1993–2000 年数据的 70%
  - 验证集：1993–2000 年数据的 30%
  - 测试集：2001–2019 年数据
- **随机选择策略**：随机选取70%的图像用于训练，30%用于验证，随机选择训练和验证样本有助于平衡正负样本的比例
- **样本平衡**：训练和验证集各包含约 50% 上升样本、50% 下降样本  
- **标签定义**：
  - y = 1：未来收益为正
  - y = 0：未来收益为负
- **负面标签作用**：使用负面标签可以减少因市场长期上涨或下跌而产生的潜在偏差
- **输入预处理**：对训练数据像素取均值和标准差进行归一化（训练/验证/测试均使用相同归一化参数）

### 模型配置与训练策略
- **三种输入选择**：过去5天、20天或60天的市场数据图像
- **三种预测期**：图像之后5天、20天或60天内的回报预测
- **九个独立模型**：3种输入窗口 × 3种预测期 = 9个独立估计的模型
- **重复训练**：由于CNN优化过程具有随机性，每个模型配置独立重新训练5次，并取平均预测结果
- **固定模型策略**：每个模型仅使用1993-2000年数据进行一次训练和验证，训练好的CNN模型在整个2001-2019年测试样本中保持不变，不进行递归再训练

---

## 三、训练参数设定
- **损失函数**：交叉熵（Cross Entropy）
  \[
  L(y, \hat{y}) = -y \log(\hat{y}) - (1-y)\log(1-\hat{y})
  \]
- **优化方法**：
  - 随机梯度下降（SGD）
  - Adam 优化器
- **初始学习率**：$1 \times 10^{-5}$
- **批量大小（Batch Size）**：128
- **权重初始化**：Xavier 初始化（Glorot & Bengio, 2010）
- **正则化**：
  - 批归一化（BN）：应用于卷积层与激活函数之间
  - Dropout：全连接层使用 50%
  - 卷积层：不使用 Dropout（因参数量较少）
- **早停策略**：验证集损失连续 2 个周期无改善时停止训练

---

## 四、训练策略说明
- **分类任务**：预测未来收益的正/负方向
- **模式学习**：通过 CNN 从低信噪比的市场图像中学习复杂的非线性模式
- **偏差控制**：采用负样本与正样本平衡设计，以避免趋势性市场造成的偏差
- **模拟验证**：采用模拟实验验证模型在有限样本下的性能表现
- **有限样本性能**：由于我们的图像与标准的CNN研究数据集（如ImageNet）存在显著差异，模拟结果为CNN在这一新环境下的表现提供了宝贵的见解
- **模式识别能力**：模拟结果显示，CNN能够成功识别出在实际低信噪比数据集中存在的复杂技术模式

## 五、模型评估与组合构建

### 评估周期与组合构建
- **预测周期**：根据模型的预测时间范围，可以是每周、每月或每季度构建新预测
- **十分位组合**：在每个构建新预测的周期，根据样本外的CNN估计值，将股票分为十分位组合，以评估后续正回报的概率
- **多空差价组合（H-L）**：构建多空差价组合，该组合持有十分位10的股票，而做空十分位1的股票
- **持有期一致性**：每个组合的持有期与每个模型的预测时间范围一致，即从图像中的最后日期起5天、20天或60天

### 符号记法
- **Ix/Ry 记号**：使用符号"Ix/Ry"来表示模型使用x天的图像来预测随后y天的持有期回报
  - 例如：I5/R5 表示使用过去5天图像预测随后5天回报
  - 例如：I20/R60 表示使用过去20天图像预测随后60天回报

---

## 六、正则化与优化策略

### 正则化参数详细说明
- **正则化方法**：采用Gu、Kelly和Xiu（2020）提出的方法，减少过拟合并提高计算效率

#### 批量归一化（Batch Normalization）
- **插入位置**：在每个构建块的"卷积层"与"激活层"之间
- **归一化方式**：基于训练集的均值和标准差对输入进行归一化
- **功能**：有效减少内部协变量偏移（Internal Covariate Shift），加速训练收敛进程

#### Dropout策略
- **应用位置**：仅在全连接层应用
- **Dropout率**：50%
- **卷积层策略**：卷积层因存在参数共享机制，无需应用Dropout
- **功能**：通过随机"关闭"部分神经元，降低模型对局部特征的过度依赖，增强模型泛化能力

#### 参数共享与稀疏交互
- **参数共享（Parameter Sharing）**：
  - 滤波器在图像所有位置共享权重
  - 大幅减少参数数量（与全连接网络相比）
  - 增强模型对特征位置的鲁棒性，实现平移等变
- **稀疏交互（Sparse Interactions）**：
  - 卷积层仅捕捉局部像素之间的交互
  - 聚焦关键价格模式，降低冗余计算，提升模型效率

### 优化策略
- **权重初始化**：Xavier初始化器（Glorot和Bengio，2010），确保预测方差与标签方差在可比较尺度上
- **优化算法**：Adam优化器（Kingma和Ba，2014），初始学习率1×10^-5，批量大小128
- **早停机制**：验证损失连续2个周期无改善时停止训练
- **模拟验证**：通过模拟实验验证CNN在低信噪比环境下的模式识别能力

---

## 七、关键参数设计逻辑总结

### 设计原则
1. **图像格式优先**：通过"价格/交易量归一化"和"空间维度保留"（如OHLC柱的高度对应波动率），使CNN能够捕捉传统时间序列模型难以识别的非线性关系，例如价格区间与收益的关联。

2. **架构适配时间跨度**：长周期图像（60天）增加构建块与滤波器数量，在"长周期模式提取"和"计算效率"之间取得平衡；短周期图像（5天）则简化架构，避免出现过拟合问题。

3. **泛化能力保障**：早停、Dropout、批量归一化的组合使用，以及"仅训练1次+固定参数测试"的设计，确保了模型在跨市场、跨时间尺度场景下的稳定性。

### 技术创新点
- **非线性关系捕捉**：将时间序列数据以图像形式嵌入，利用卷积滤波器捕捉不同价格曲线之间的非线性空间关系
- **特征自动整合**：图像自动整合方向性价格变动、相对于移动平均趋势的变动、价格波动性和交易量等信息
- **模式识别优势**：通过将整个数据矩阵可视化为单个图像，使统计模式识别算法能够更有效地识别复杂的价格模式

以上参数共同构成了"图像-CNN"预测框架的核心，也是该框架在股票收益预测中能够超越传统动量、反转策略的关键技术基础。